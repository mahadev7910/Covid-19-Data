create table country(

	country_code char(3) primary key,
	name varchar(30)	
);

create table country_data(
	
	country_code char(3) references country,
	cases int default 0,
	active int default 0,
	recovered int default 0,
	deaths int default 0,
	recovery_rate float default 0,
	death_rate float default 0,
	last_update date default current_date,
	PRIMARY KEY(country_code,last_update)
);

create table state(
    
    country_code char(3) references country,
	state_code char(2) PRIMARY KEY,
	state_name char(120)
);

create table state_data(

	state_code char(2) references state,
	cases int default 0,
	active int default 0,
	recovered int default 0,
	deaths int default 0,
	recovery_rate float default 0,
	death_rate float default 0,
	last_update date default current_date,
	PRIMARY KEY(state_code,last_update)
);

create table district(
    
    dist_id int PRIMARY KEY,
	state_code char(2) references state,
	dist varchar(50)	
);

create table district_data(
	
	dist_id int references district,
	cases int default 0,
	active int default 0,
	recovered int default 0,
	deaths int default 0,
	recovery_rate float default 0,
	death_rate float default 0,
	last_update date default current_date,
	PRIMARY KEY(dist_id,last_update)
);


create table covid_center(
   
    dist_id int references district,
    cov_id serial PRIMARY KEY,
	name char(70)
);

create table covid_center_data(

	cov_id int references covid_center,
	cases int default 0,
	active int default 0,
	recovered int default 0,
	deaths int default 0,
	last_update date default current_date,
	PRIMARY KEY(cov_id,last_update)
);

create table staff(
    id serial PRIMARY KEY,
    email varchar(50) unique not null,
    password varchar(20) not null,
    mob int not null,
    cov_id int references covid_center(id)
);

create table volunteer(
    id serial primary key,
    fname varchar(30),
    lname varchar(30),
    email varchar(50) unique not null,
    address text
); 

CREATE VIEW India AS
SELECT 
    SUM(total_cases) as "total_cases",
    SUM(active_cases) as "active_cases",
    SUM(recovered) as "recovered",
    SUM(deaths) as "deaths"
FROM state;

CREATE OR REPLACE FUNCTION update_state_data() RETURNS TRIGGER AS'
DECLARE
        total int := 0;
        active int := 0;
        recover int := 0;
        death int := 0;
        state_code CHAR(2) := '''';
BEGIN
        RAISE NOTICE ''Hello World!'';
        RAISE NOTICE ''%'',new.state_code;
        SELECT INTO total,active,recover,death SUM(total_cases),SUM(active_cases),SUM(recovered),SUM(deaths) FROM district WHERE district.state_code=new.state_code;
        UPDATE state SET total_cases = total,active_cases=active,recovered=recover,deaths=death WHERE code=new.state_code;
        
        RETURN null;
END;
' language 'plpgsql';

create trigger state_update_trigger after insert or update on district
for each row execute procedure update_state_data();

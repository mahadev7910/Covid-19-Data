create or replace function countryData() RETURNS trigger as

'DECLARE

	total float := 0;
	act float := 0;
	reco float := 0;
	de float := 0;
	rrate float := 0;
	drate float := 0;
	stcode char(2) :='''';
	dd date;
	one int:=0;
		
BEGIN
	
	SELECT INTO total,act,reco,de SUM(cases),SUM(active),SUM(recovered),SUM(deaths) 
	FROM state_data,state
	WHERE last_update = new.last_update and state.state_code = state_data.state_code;
	
	rrate := (reco/(total-de))*100;
	drate := (de/total)*100;
	
	select into one 1 from country_data where last_update = new.last_update;
	
IF one = 1 THEN	

	UPDATE country_data SET cases = total,active = act,recovered = reco,deaths = de,recovery_rate = rrate,death_rate = drate;

ELSE
		INSERT INTO country_data(country_code,cases,active,recovered,deaths,recovery_rate,death_rate,last_update) values(''IND'',total,act,reco,de,rrate,drate,new.last_update);

END IF;	
RETURN NULL;	
END;
'LANGUAGE 'plpgsql';

CREATE TRIGGER countryUpdate AFTER INSERT OR UPDATE ON state_data
FOR EACH ROW EXECUTE PROCEDURE countryData();	
